# ABR Hierarchical U-Net Configuration
# Denoising Diffusion Model for ABR Signal Generation

project:
  name: "ABR_HierarchicalUNet_Diffusion"
  description: "Hierarchical U-Net with S4 Encoder and Transformer Decoder for ABR Signal Generation"
  version: "1.0.0"
  author: "AI Assistant"

# Data Configuration
data:
  dataset_path: "data/processed/ultimate_dataset_with_clinical_thresholds.pkl"
  signal_length: 200
  static_dim: 4  # age, intensity, stimulus_rate, fmp
  n_classes: 5   # hearing loss types
  
  # Data splits (patient-stratified) - Optimized
  splits:
    train_ratio: 0.75    # Increased training data
    val_ratio: 0.15
    test_ratio: 0.10     # Reduced test set for more training data
    random_seed: 42
  
  # Data loading - Optimized
  dataloader:
    batch_size: 48       # Increased for better gradient estimates
    num_workers: 6       # More workers for faster loading
    pin_memory: true
    drop_last: true
    shuffle_train: true
    prefetch_factor: 3   # Better performance
    persistent_workers: true  # Efficiency improvement

# Model Architecture
model:
  type: "hierarchical_unet"
  
  # Architecture parameters - Optimized
  architecture:
    signal_length: 200
    static_dim: 4
    base_channels: 80      # Increased for more capacity
    n_levels: 4
    n_classes: 5
    dropout: 0.15          # Increased for better regularization
    
    # S4 Encoder settings - Enhanced
    encoder:
      n_s4_layers: 3       # Increased depth
      d_state: 80          # Increased capacity
      use_enhanced_s4: true
      
    # Transformer Decoder settings - Enhanced
    decoder:
      n_transformer_layers: 3  # Increased depth
      n_heads: 8              # Fixed: d_model must be divisible by n_heads
      use_multi_scale_attention: true
      use_cross_attention: true
      
    # FiLM conditioning - Enhanced
    film:
      hidden_dim: 96       # Increased capacity
      dropout: 0.15        # Added dropout
      
    # Output heads - Enhanced
    outputs:
      signal_activation: "tanh"
      peak_head_dim: 256   # Increased capacity
      class_head_dim: 256  # Increased capacity
      threshold_head_dim: 256  # Increased capacity
      use_attention_heads: true
      predict_uncertainty: true

# Diffusion Configuration
diffusion:
  # Noise schedule
  noise_schedule:
    type: "cosine"  # linear, cosine, quadratic
    num_timesteps: 1000
    peak_preserve_ratio: 0.3
    beta_start: 5e-5
    beta_end: 0.015
  
  # Sampling
  sampling:
    type: "ddpm"  # ddpm, ddim
    ddim_eta: 0.0
    num_sampling_steps: 50
    temperature: 1.0
    clip_denoised: true
    
    # Clinical constraints
    constraints:
      apply_constraints: true
      peak_latency_range: [1.0, 8.0]  # ms
      amplitude_range: [-0.5, 0.5]   # Î¼V
      smooth_kernel_size: 5

# Training Configuration
training:
  # Optimizer - Optimized
  optimizer:
    type: "adamw"
    learning_rate: 2e-4    # Increased for faster convergence
    weight_decay: 1e-4     # Increased for better regularization
    betas: [0.9, 0.95]     # Optimized betas
    eps: 1e-8
    amsgrad: false         # Disabled for faster training
  
  # Learning rate scheduler - Optimized
  scheduler:
    type: "cosine_annealing_warm_restarts"
    T_0: 30               # More frequent restarts
    T_mult: 1.5           # Smoother progression
    eta_min: 5e-7         # Lower minimum LR
    warmup_epochs: 5      # Shorter warmup
  
  # Training parameters - Optimized
  epochs: 300             # Increased for better convergence
  gradient_clip: 0.5      # Reduced for stability
  accumulation_steps: 2   # Gradient accumulation
  log_frequency: 25       # More frequent logging
  
  # Validation and checkpointing
  validation:
    frequency: 1
    compute_metrics: true
  
  checkpointing:
    save_frequency: 5      # More frequent saves
    save_best: true
    save_last: true
    save_dir: "checkpoints"
  
  # Early stopping - Optimized
  early_stopping:
    patience: 50           # Increased patience
    min_delta: 1e-5        # Increased threshold
    monitor: "val_total_loss"
    mode: "min"

# Loss Configuration
loss:
  type: "abr_diffusion"
  
  # Loss weights - Optimized for better balance
  weights:
    diffusion: 1.0
    peak_exist: 0.8        # Increased importance
    peak_latency: 1.2      # Increased importance
    peak_amplitude: 1.2    # Increased importance
    classification: 1.5    # Increased importance
    threshold: 1.0         # Increased importance
  
  # Loss settings - Optimized
  peak_loss_type: "smooth_l1"  # Better than huber for peaks
  huber_delta: 0.5             # Reduced delta
  
  # Class imbalance handling - Enhanced
  class_weights: "balanced"
  focal_loss:
    use_focal: true        # Enabled for better class balance
    alpha: 0.75            # Optimized alpha
    gamma: 2.5             # Increased gamma
  
  # Perceptual loss
  perceptual:
    use_perceptual: false
    feature_weights:
      peak_preservation: 2.0
      morphology: 1.0
      spectral: 0.5
      temporal: 1.0

# Evaluation Configuration
evaluation:
  metrics:
    # Signal quality metrics
    signal_metrics: ["mse", "mae", "correlation", "dtw_distance"]
    
    # Peak prediction metrics
    peak_metrics: ["peak_mae", "peak_accuracy", "existence_f1"]
    
    # Classification metrics
    classification_metrics: ["accuracy", "f1_macro", "f1_weighted", "confusion_matrix"]
    
    # Threshold metrics
    threshold_metrics: ["threshold_mae", "threshold_r2"]
  
  # Visualization
  visualization:
    save_plots: true
    plot_types: ["reconstruction", "peaks", "latent_space", "generation_samples"]
    n_samples_plot: 10
    
  # Output
  output_dir: "outputs/evaluation"
  save_detailed_results: true

# Inference Configuration
inference:
  # Generation parameters
  generation:
    num_samples: 100
    batch_size: 16
    temperature: 1.0
    guidance_scale: 1.0
    
  # Conditional generation
  conditioning:
    age_range: [20, 80]
    intensity_range: [60, 100]
    rate_range: [10, 80]
    fmp_range: [0.5, 1.0]
    
  # Output
  output_dir: "outputs/inference"
  save_formats: ["signals", "peaks", "predictions", "metadata"]

# Logging and Monitoring
logging:
  level: "INFO"
  log_dir: "logs"
  use_tensorboard: true
  use_wandb: true          # Enabled for better experiment tracking
  
  # Weights & Biases configuration (if enabled)
  wandb:
    project: "abr-hierarchical-unet"
    entity: null
    tags: ["diffusion", "abr", "s4", "transformer"]

# Reproducibility
reproducibility:
  seed: 42
  deterministic: true      # Enabled for reproducible results
  benchmark: false         # Disabled for deterministic behavior

# Hardware Configuration
hardware:
  device: "auto"  # auto, cuda, cpu
  gpu_id: 0
  mixed_precision: true
  compile_model: true   # Enabled PyTorch 2.0 compilation for speed

# Paths
paths:
  data_dir: "data"
  model_dir: "models"
  checkpoint_dir: "checkpoints"
  output_dir: "outputs"
  log_dir: "logs" 